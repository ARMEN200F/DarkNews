<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>DarkNews</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { background:#000; color:#f00; font-family:Arial; text-align:center }
.box { background:#111; padding:20px; margin:20px auto; max-width:500px; text-align:left }
button { background:#f00; color:#fff; border:none; padding:10px 15px; cursor:pointer; margin:8px 0; width:100% }
textarea, input { width:100%; background:#222; color:#fff; border:1px solid #444; padding:8px }
.article { border-left:4px solid #f00; padding:10px; margin:15px 0; background:#151515; text-align:left; position:relative }
.comment { background:#222; padding:6px; margin:6px 0; position:relative }
.menu { position:absolute; top:4px; right:6px; cursor:pointer; color:red; font-weight:bold }
.menuBox { background:#111; border:1px solid #400; padding:5px; margin-top:5px }
</style>
</head>
<body>

<!-- üî¥ LOGIN SCREEN -->
<div id="loginBox" class="box">
<h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ DarkNews</h2>
<button onclick="openUser()">–í–æ–π—Ç–∏ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</button>
<button onclick="openAuthor()">–í–æ–π—Ç–∏ –∫–∞–∫ –∞–≤—Ç–æ—Ä</button>
</div>

<div id="authorLogin" class="box" style="display:none">
<input id="promo" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥">
<button onclick="checkPromo()">–í–æ–π—Ç–∏</button>
</div>

<div id="authorPanel" class="box" style="display:none">
<textarea id="articleText" placeholder="–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏"></textarea>
<button onclick="addArticle()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
</div>

<div id="articles" class="box" style="display:none">
<h3>–°—Ç–∞—Ç—å–∏</h3>
<div id="list"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCcg7VJbtbhluJMIfCSzdPZUKoQmYT43ro",
  authDomain: "darknews-904eb.firebaseapp.com",
  projectId: "darknews-904eb"
});
const db = firebase.firestore();

const PROMO = "087212";
let IS_AUTHOR = false;

function openUser(){
  IS_AUTHOR = false;
  loginBox.style.display="none";
  articles.style.display="block";
  loadArticles();
}

function openAuthor(){
  loginBox.style.display="none";
  authorLogin.style.display="block";
}

function checkPromo(){
  if(promo.value === PROMO){
    IS_AUTHOR = true;
    authorLogin.style.display="none";
    authorPanel.style.display="block";
    articles.style.display="block";
    loadArticles();
  } else alert("–ù–µ–≤–µ—Ä–Ω–æ");
}

function addArticle(){
  const text = articleText.value.trim();
  if(!text) return;
  db.collection("articles").add({ text, likes:0, comments:[] });
  articleText.value="";
}

function loadArticles(){
  db.collection("articles").onSnapshot(snap=>{
    list.innerHTML="";
    snap.forEach(doc=>{
      const a = doc.data();
      const div = document.createElement("div");
      div.className="article";
      div.id = "a"+doc.id;
      div.innerHTML = `
        <p>${a.text}</p>
        ${IS_AUTHOR ? `
        <span class="menu" onclick="toggleArticleMenu('${doc.id}')">‚ãÆ</span>
        <div id="am${doc.id}" class="menuBox" style="display:none">
          <button onclick="editArticle('${doc.id}')">–ò–∑–º–µ–Ω–∏—Ç—å</button>
          <button onclick="deleteArticle('${doc.id}')">–£–¥–∞–ª–∏—Ç—å</button>
        </div>` : ""}
        <button onclick="like('${doc.id}',${a.likes})">‚ù§Ô∏è ${a.likes}</button>
        ${(a.comments||[]).map((c,i)=>`
          <div class="comment">
            ${IS_AUTHOR ? `
              <span class="menu" onclick="toggleMenu('${doc.id}',${i})">‚ãÆ</span>
              <div id="m${doc.id}${i}" class="menuBox" style="display:none">
                <button onclick="editComment('${doc.id}',${i})">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                <button onclick="deleteComment('${doc.id}',${i})">–£–¥–∞–ª–∏—Ç—å</button>
              </div>` : ""}
            <div id="t${doc.id}${i}">${c}</div>
          </div>`).join("")}
        <textarea id="c${doc.id}" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
        <button onclick="comment('${doc.id}')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      `;
      list.appendChild(div);
    });
  });
}

// üîπ Article functions
function toggleArticleMenu(id){
  const m = document.getElementById("am"+id);
  m.style.display = m.style.display==="none"?"block":"none";
}

function deleteArticle(id){
  if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Ç–∞—Ç—å—é?")){
    db.collection("articles").doc(id).delete();
  }
}

function editArticle(id){
  const div = document.getElementById("a"+id);
  const oldText = div.querySelector("p").innerText;
  div.querySelector("p").innerHTML = `<textarea id="art${id}" style="width:100%">${oldText}</textarea>
                                      <button onclick="saveArticle('${id}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
}

function saveArticle(id){
  const newText = document.getElementById("art"+id).value;
  db.collection("articles").doc(id).update({text:newText});
}

// üîπ Comment functions
function like(id,l){ db.collection("articles").doc(id).update({likes:l+1}); }

function comment(id){
  const t=document.getElementById("c"+id).value;
  if(t) db.collection("articles").doc(id)
    .update({comments:firebase.firestore.FieldValue.arrayUnion(t)});
}

function toggleMenu(id,i){
  const m=document.getElementById("m"+id+i);
  m.style.display=m.style.display==="none"?"block":"none";
}

function deleteComment(id,i){
  const r=db.collection("articles").doc(id);
  r.get().then(d=>{
    let a=d.data().comments;
    a.splice(i,1);
    r.update({comments:a});
  });
}

function editComment(id,i){
  const e=document.getElementById("t"+id+i);
  const oldText = e.innerText;
  e.innerHTML = `<textarea id="e${id}${i}" style="width:100%">${oldText}</textarea>
                 <button onclick="saveComment('${id}',${i})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
}

function saveComment(id,i){
  const r=db.collection("articles").doc(id);
  r.get().then(d=>{
    let a=d.data().comments;
    const newText = document.getElementById("e"+id+i).value;
    a[i] = newText;
    r.update({comments:a});
  });
}
</script>
</body>
</html>