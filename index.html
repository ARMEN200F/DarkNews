<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>DarkNews</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { background:#000; color:#f00; font-family:Arial; text-align:center; }
.box { background:#111; padding:20px; margin:20px auto; max-width:500px; text-align:left; position:relative; }
button { background:#f00; color:#fff; border:none; padding:10px 15px; cursor:pointer; margin:8px 0; width:100%; }
textarea, input { width:100%; background:#222; color:#fff; border:1px solid #444; padding:8px; margin:5px 0; }
.article { border-left:4px solid #f00; padding:10px; margin:15px 0; background:#151515; text-align:left; position:relative; }
.comment { background:#222; padding:6px; margin:6px 0; position:relative; }
img.article-img { max-width:100%; margin:10px 0; display:block; }
#previewContainer img { max-width:100%; border-radius:5px; display:block; margin:5px 0; }
.comment-options { float:right; cursor:pointer; margin-left:10px; color:#fff; }
.delete-btn { background:#f00; color:#fff; border:none; padding:3px 5px; cursor:pointer; margin-left:5px; }
</style>
</head>
<body>

<div id="loginBox" class="box">
<h2>Добро пожаловать в DarkNews</h2>
<button onclick="openUser()">Войти как пользователь</button>
<button onclick="openAuthor()">Войти как автор</button>
</div>

<div id="authorLogin" class="box" style="display:none">
<input id="promo" placeholder="Промокод">
<button onclick="checkPromo()">Войти</button>
</div>

<div id="authorPanel" class="box" style="display:none">
<textarea id="articleText" placeholder="Текст статьи"></textarea>
<div>
<button onclick="chooseFile('top')">Добавить фотографию сверху</button>
<button onclick="chooseFile('bottom')">Добавить фотографию снизу</button>
<input type="file" id="fileInput" style="display:none" accept="image/*">
</div>

<div id="previewContainer" style="text-align:center; margin:10px 0; display:none;">
  <img id="previewImg" src="">
</div>

<button onclick="addArticle()">Опубликовать</button>
</div>

<div id="articles" class="box" style="display:none">
<h3>Статьи</h3>
<div id="list"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCcg7VJbtbhluJMIfCSzdPZUKoQmYT43ro",
  authDomain: "darknews-904eb.firebaseapp.com",
  projectId: "darknews-904eb",
  storageBucket: "darknews-904eb.appspot.com"
});

const db = firebase.firestore();
const storage = firebase.storage();

let IS_AUTHOR = false;
let selectedFile = null;
let imgPosition = "top";

// Входы
function openUser(){ 
  IS_AUTHOR=false; 
  loginBox.style.display="none"; 
  articles.style.display="block"; 
  loadArticles(); 
}
function openAuthor(){ loginBox.style.display="none"; authorLogin.style.display="block"; }
function checkPromo(){ 
  if(promo.value==="087212"){ 
    IS_AUTHOR=true; 
    authorLogin.style.display="none"; 
    authorPanel.style.display="block"; 
    articles.style.display="block"; 
    loadArticles(); 
  } else alert("Неверно"); 
}

// Выбор файла
function chooseFile(position){
  imgPosition = position;
  document.getElementById('fileInput').click();
}

document.getElementById('fileInput').addEventListener('change', function(e){
  if(e.target.files[0]){
    selectedFile = e.target.files[0];

    const reader = new FileReader();
    reader.onload = function(event){
      const preview = document.getElementById('previewImg');
      preview.src = event.target.result;
      document.getElementById('previewContainer').style.display = 'block';
    }
    reader.readAsDataURL(selectedFile);
  }
});

// Добавление статьи
function addArticle(){
  const text = articleText.value.trim();
  if(!text && !selectedFile) return;

  if(selectedFile){
    const storageRef = storage.ref('articles/'+Date.now()+'_'+selectedFile.name);
    storageRef.put(selectedFile).then(snap=>{
      snap.ref.getDownloadURL().then(url=>{
        saveArticle(text, url);
        document.getElementById('previewContainer').style.display='none';
      });
    });
  } else {
    saveArticle(text, null);
  }

  articleText.value="";
  selectedFile=null;
}

// Сохранение статьи
function saveArticle(text, imgUrl){
  let articleData = {text:text, likes:0, comments:[]};
  if(imgUrl){
    if(imgPosition==="top") articleData.imgTop = imgUrl;
    else articleData.imgBottom = imgUrl;
  }
  db.collection("articles").add(articleData);
}

// Загрузка статей
function loadArticles(){
  db.collection("articles").onSnapshot(snap=>{
    list.innerHTML="";
    snap.forEach(doc=>{
      const a = doc.data();
      const div = document.createElement("div");
      div.className="article";

      let contentHTML="";
      if(IS_AUTHOR){
        contentHTML += `<div style="text-align:right;"><button class="delete-btn" onclick="deleteArticle('${doc.id}')">Удалить статью</button></div>`;
      }
      if(a.imgTop) contentHTML += `<img class="article-img" src="${a.imgTop}">`;
      if(a.text) contentHTML += `<p>${a.text}</p>`;
      if(a.imgBottom) contentHTML += `<img class="article-img" src="${a.imgBottom}">`;

      // Комментарии с ⋮ и кнопкой «Удалить»
      let commentsHTML = (a.comments||[]).map((c,index)=>{
        if(IS_AUTHOR){
          return `<div class="comment" id="comment-${doc.id}-${index}">
                    ${c} 
                    <span class="comment-options" onclick="toggleDeleteButton('${doc.id}', ${index})">⋮</span>
                    <button id="delete-btn-${doc.id}-${index}" class="delete-btn" style="display:none;" onclick="deleteComment('${doc.id}','${c}')">Удалить</button>
                  </div>`;
        } else {
          return `<div class="comment">${c}</div>`;
        }
      }).join("");

      div.innerHTML = `
        ${contentHTML}
        <button onclick="like('${doc.id}',${a.likes})">❤️ ${a.likes}</button>
        ${commentsHTML}
        <textarea id="c${doc.id}" placeholder="Комментарий"></textarea>
        <button onclick="comment('${doc.id}')">Отправить</button>
      `;
      list.appendChild(div);
    });
  });
}

// Лайки и комментарии
function like(id,l){ db.collection("articles").doc(id).update({likes:l+1}); }

function comment(id){ 
  const t = document.getElementById("c"+id).value;
  if(!t) return;
  const ref = db.collection("articles").doc(id);
  ref.update({comments: firebase.firestore.FieldValue.arrayUnion(t)});
  document.getElementById("c"+id).value="";
}

// Показать/скрыть кнопку удаления комментария
function toggleDeleteButton(articleId, index){
  const btn = document.getElementById(`delete-btn-${articleId}-${index}`);
  if(btn.style.display === 'none'){
    btn.style.display = 'inline-block';
  } else {
    btn.style.display = 'none';
  }
}

// Удаление комментария
function deleteComment(articleId, commentText){
  if(!IS_AUTHOR) return;
  const ref = db.collection("articles").doc(articleId);
  ref.update({
    comments: firebase.firestore.FieldValue.arrayRemove(commentText)
  });
}

// Удаление статьи
function deleteArticle(articleId){
  if(!IS_AUTHOR) return;
  if(confirm("Удалить статью?")) {
    db.collection("articles").doc(articleId).delete();
  }
}
</script>
</body>
</html>