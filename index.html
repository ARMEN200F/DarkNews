<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DarkNews</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #000000;
            color: #FF0000;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .content { padding: 20px; background-color: #121212; margin-bottom: 20px; }
        .button-container { text-align: center; margin-top: 20px; }
        .button-container button { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #FF0000; color: white; border: none; margin: 5px; }
        .article { background-color: #1a1a1a; padding: 10px; margin-bottom: 20px; border-left: 5px solid #FF0000; }
        .comment { background-color: #333333; padding: 10px; margin-bottom: 10px; }
        textarea, input[type="text"], input[type="password"], input[type="email"] { background-color: #1a1a1a; color: white; border: 1px solid #555; width: 100%; padding: 8px; margin-top: 10px; resize: vertical; }
        img { display: block; margin-top: 10px; max-width: 100%; height: auto; }
    </style>
</head>
<body>

<div class="container">
    <div class="content" id="loginSection">
        <h1>Добро пожаловать на DarkNews!</h1>
        <div class="button-container">
            <button onclick="showUserLogin()">Войти как пользователь</button>
            <button onclick="showAuthorLogin()">Войти как автор</button>
        </div>
    </div>

    <div id="userLogin" class="content" style="display:none;">
        <h2>Вход через Gmail</h2>
        <input type="email" id="userEmail" placeholder="Введите Gmail" autocomplete="off" />
        <input type="password" id="userPassword" placeholder="Введите пароль" autocomplete="off" />
        <button onclick="verifyUser()">Войти / Зарегистрироваться</button>
    </div>

    <div id="articles" class="content" style="display:none;">
        <h2>Статьи</h2>
        <div id="articleList"></div>
    </div>

    <div id="authorLogin" class="content" style="display:none;">
        <h2>Введите промокод для входа как автор</h2>
        <input type="text" id="promoCode" placeholder="Промокод" autocomplete="off" />
        <button onclick="verifyPromoCode()">Войти как автор</button>
    </div>

    <div id="authorSection" class="content" style="display:none;">
        <h2>Создайте свою статью</h2>
        <textarea id="articleInput" placeholder="Напишите вашу статью..." rows="4"></textarea>
        <h3>Загрузите изображение для вашей статьи</h3>
        <input type="file" id="imageInput" accept="image/*" />
        <button onclick="submitArticle()">Опубликовать статью</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

// ----------------------- Firebase -----------------------
const firebaseConfig = {
  apiKey: "AIzaSyCcg7VJbtbhluJMIfCSzdPZUKoQmYT43ro",
  authDomain: "darknews-904eb.firebaseapp.com",
  projectId: "darknews-904eb",
  storageBucket: "darknews-904eb.firebasestorage.app",
  messagingSenderId: "699679383044",
  appId: "1:699679383044:web:9350eef89940dca0771f51",
  measurementId: "G-LCTR7ZX0K0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ----------------------- Авторизация -----------------------
const validPromoCode = "087212";
let currentUserEmail = null;

function showUserLogin() {
    document.getElementById("userLogin").style.display = "block";
    document.getElementById("articles").style.display = "none";
    document.getElementById("authorLogin").style.display = "none";
    document.getElementById("authorSection").style.display = "none";
    document.getElementById("loginSection").style.display = "none";
}

async function verifyUser() {
    const email = document.getElementById("userEmail").value.trim();
    const password = document.getElementById("userPassword").value.trim();
    if (!email || !password) { alert("Введите Gmail и пароль"); return; }
    currentUserEmail = email;
    alert("Вход выполнен!");
    showArticles();
}

function showAuthorLogin() {
    document.getElementById("authorLogin").style.display = "block";
    document.getElementById("articles").style.display = "none";
    document.getElementById("authorSection").style.display = "none";
    document.getElementById("userLogin").style.display = "none";
    document.getElementById("loginSection").style.display = "none";
}

function verifyPromoCode() {
    const promoCode = document.getElementById("promoCode").value.trim();
    if (promoCode === validPromoCode) {
        document.getElementById("authorSection").style.display = "block";
        document.getElementById("authorLogin").style.display = "none";
    } else { alert("Неправильный промокод"); }
}

// ----------------------- Статьи и Firestore -----------------------
async function submitArticle() {
    const articleText = document.getElementById("articleInput").value.trim();
    const imageFile = document.getElementById("imageInput").files[0];

    if (!articleText && !imageFile) { alert("Пожалуйста, добавьте текст или изображение."); return; }

    if (imageFile) {
        const reader = new FileReader();
        reader.onloadend = async function () {
            await saveArticle(articleText, reader.result);
        };
        reader.readAsDataURL(imageFile);
    } else {
        await saveArticle(articleText, "");
    }
}

async function saveArticle(text, image) {
    await addDoc(collection(db, "articles"), {
        text: text,
        image: image,
        likes: 0,
        comments: [],
        createdAt: Date.now()
    });
    document.getElementById("articleInput").value = "";
    document.getElementById("imageInput").value = "";
    displayArticles();
}

async function displayArticles() {
    document.getElementById("articles").style.display = "block";
    const articleList = document.getElementById("articleList");
    articleList.innerHTML = "";

    const querySnapshot = await getDocs(collection(db, "articles"));
    querySnapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;

        const articleDiv = document.createElement("div");
        articleDiv.classList.add("article");

        const articleText = document.createElement("p");
        articleText.textContent = data.text;
        articleDiv.appendChild(articleText);

        if (data.image) {
            const articleImage = document.createElement("img");
            articleImage.src = data.image;
            articleDiv.appendChild(articleImage);
        }

        // Лайки
        const likeBtn = document.createElement("button");
        likeBtn.textContent = `❤️ ${data.likes || 0}`;
        likeBtn.onclick = async () => {
            await updateDoc(doc(db, "articles", id), { likes: (data.likes || 0) + 1 });
            displayArticles();
        };
        articleDiv.appendChild(likeBtn);

        // Комментарии
        const commentSection = document.createElement("div");
        commentSection.classList.add("comment");
        if (data.comments) {
            data.comments.forEach(c => {
                const p = document.createElement("p");
                p.textContent = c;
                commentSection.appendChild(p);
            });
        }
        articleDiv.appendChild(commentSection);

        // Добавить новый комментарий
        const newCommentInput = document.createElement("textarea");
        newCommentInput.rows = 2;
        newCommentInput.placeholder = "Напишите комментарий...";
        newCommentInput.style.width = "100%";
        articleDiv.appendChild(newCommentInput);

        const addCommentBtn = document.createElement("button");
        addCommentBtn.textContent = "Добавить комментарий";
        addCommentBtn.onclick = async () => {
            const comment = newCommentInput.value.trim();
            if (!comment) { alert("Комментарий пустой"); return; }
            const newComments = data.comments ? [...data.comments, comment] : [comment];
            await updateDoc(doc(db, "articles", id), { comments: newComments });
            displayArticles();
        };
        articleDiv.appendChild(addCommentBtn);

        articleList.appendChild(articleDiv);
    });
}

// ----------------------- Старт -----------------------
displayArticles();
</script>