<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>DarkNews</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background:#000; color:#f00; font-family:Arial }
    .box { background:#111; padding:15px; margin:15px 0 }
    button { background:#f00; color:#fff; border:none; padding:8px 12px; cursor:pointer; margin:5px 0 }
    textarea, input { width:100%; background:#222; color:#fff; border:1px solid #444; padding:8px }
    .article { border-left:4px solid #f00; padding:10px; margin:15px 0; background:#151515 }
    .comment { background:#222; padding:6px; margin:6px 0; position:relative }
    .menu {
      position:absolute;
      top:4px;
      right:6px;
      cursor:pointer;
      color:red;
      font-weight:bold;
    }
    .menuBox {
      background:#111;
      border:1px solid #400;
      padding:5px;
      margin-top:5px;
    }
  </style>
</head>
<body>

<div id="loginBox" class="box">
  <h2>DarkNews</h2>
  <button onclick="openUser()">Войти как пользователь</button>
  <button onclick="openAuthor()">Войти как автор</button>
</div>

<div id="authorLogin" class="box" style="display:none">
  <input id="promo" placeholder="Промокод">
  <button onclick="checkPromo()">Войти</button>
</div>

<div id="authorPanel" class="box" style="display:none">
  <textarea id="articleText" placeholder="Текст статьи"></textarea>
  <button onclick="addArticle()">Опубликовать</button>
</div>

<div id="articles" class="box" style="display:none">
  <h3>Статьи</h3>
  <div id="list"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  firebase.initializeApp({
    apiKey: "AIzaSyCcg7VJbtbhluJMIfCSzdPZUKoQmYT43ro",
    authDomain: "darknews-904eb.firebaseapp.com",
    projectId: "darknews-904eb"
  });

  const db = firebase.firestore();
</script>

<script>
  const PROMO = "087212";
  let IS_AUTHOR = false;

  function openUser(){
    IS_AUTHOR = false;
    loginBox.style.display="none";
    articles.style.display="block";
    loadArticles();
  }

  function openAuthor(){
    loginBox.style.display="none";
    authorLogin.style.display="block";
  }

  function checkPromo(){
    if(promo.value === PROMO){
      IS_AUTHOR = true;
      authorLogin.style.display="none";
      authorPanel.style.display="block";
      articles.style.display="block";
      loadArticles();
    } else alert("Неверно");
  }

  function addArticle(){
    const text = articleText.value.trim();
    if(!text) return;
    db.collection("articles").add({ text, likes:0, comments:[] });
    articleText.value="";
  }

  function loadArticles(){
    db.collection("articles").onSnapshot(snap=>{
      list.innerHTML="";
      snap.forEach(doc=>{
        const a = doc.data();
        const div = document.createElement("div");
        div.className="article";

        div.innerHTML = `
          <p>${a.text}</p>
          <button onclick="like('${doc.id}',${a.likes})">❤️ ${a.likes}</button>

          <div>
            ${(a.comments||[]).map((c,i)=>`
              <div class="comment">
                ${IS_AUTHOR ? `
                  <span class="menu" onclick="toggleMenu('${doc.id}',${i})">⋮</span>
                  <div id="m${doc.id}${i}" class="menuBox" style="display:none">
                    <button onclick="deleteComment('${doc.id}',${i})">Удалить</button>
                  </div>
                ` : ""}
                ${c}
              </div>
            `).join("")}

            <textarea id="c${doc.id}" placeholder="Комментарий"></textarea>
            <button onclick="comment('${doc.id}')">Отправить</button>
          </div>
        `;
        list.appendChild(div);
      });
    });
  }

  function like(id,l){
    db.collection("articles").doc(id).update({likes:l+1});
  }

  function comment(id){
    const t = document.getElementById("c"+id).value;
    if(!t) return;
    db.collection("articles").doc(id)
      .update({ comments: firebase.firestore.FieldValue.arrayUnion(t) });
  }

  function toggleMenu(id,i){
    const m = document.getElementById("m"+id+i);
    m.style.display = m.style.display==="none" ? "block" : "none";
  }

  function deleteComment(id,i){
    const ref = db.collection("articles").doc(id);
    ref.get().then(d=>{
      const arr = d.data().comments || [];
      arr.splice(i,1);
      ref.update({comments:arr});
    });
  }
</script>

</body>
</html>